version: "2"

services:
  app:
    build:
      context: ../
      dockerfile: ./systems/Dockerfile
    command: >
      bash -c "
        cabal update &&
        cabal install --only-dependencies &&
        cabal run exe:non-stack-yesod
      "
    environment:
      PORT: 3000
      DATABASE_URL: postgres://postgres:@postgres:5432/postgres
    ports:
      - 3000:3000
    volumes:
      - ../main.hs:/app/main.hs
      - ../src:/app/src
      - ../cabal.config:/app/cabal.config
      - ../non-stack-yesod.cabal:/app/non-stack-yesod.cabal
      - app_data:/app/dist
      - app_data:/root/.cabal
      - app_data:/root/.ghc

  test:
    build:
      context: ../
      dockerfile: ./systems/Dockerfile
    command: >
      bash -c "
        cabal update &&
        cabal install --only-dependencies --enable-tests &&
        cabal configure --enable-tests &&
        cabal test --show-details=always
      "
    environment:
      DATABASE_URL: postgres://postgres:@postgres:5432/postgres_test
    volumes:
      - ../main.hs:/app/main.hs
      - ../src:/app/src
      - ../test:/app/test
      - ../cabal.config:/app/cabal.config
      - ../non-stack-yesod.cabal:/app/non-stack-yesod.cabal
      - app_data:/app/dist
      - app_data:/root/.cabal
      - app_data:/root/.ghc

  postgres:
    image: postgres:9.5.3
    environment:
      POSTGRES_DB: postgres_test
    volumes:
      - postgres_data:/var/lib/postgresql/data

  flyway:
    image: hiogawa/flyway:4.0.1
    environment:
      FLYWAY_URL: jdbc:postgresql://postgres:5432/postgres
      FLYWAY_USER: postgres
      FLYWAY_PASSWORD:
    volumes:
      - ./sql:/flyway/sql

  flyway_test:
    image: hiogawa/flyway:4.0.1
    environment:
      FLYWAY_URL: jdbc:postgresql://postgres:5432/postgres_test
      FLYWAY_USER: postgres
      FLYWAY_PASSWORD:
    volumes:
      - ./sql:/flyway/sql

  builder:
    build:
      context: ../
      dockerfile: ./systems/Dockerfile
    command: >
      bash -c "
        cabal update &&
        cabal install --only-dependencies &&
        cabal install
        tar -czf build/production.tar.gz -C /root/.cabal/bin production
      "
    volumes:
      - ../main.hs:/app/main.hs
      - ../src:/app/src
      - ../cabal.config:/app/cabal.config
      - ../non-stack-yesod.cabal:/app/non-stack-yesod.cabal
      - app_data:/app/dist
      - app_data:/root/.cabal
      - app_data:/root/.ghc
      - ./build:/app/build

  distributor:
    build:
      context: ../
      dockerfile: ./systems/Dockerfile.dist
    image: registry.heroku.com/yesod-free-deploy/web

  flyway_production:
    image: hiogawa/flyway:4.0.1
    environment:
      FLYWAY_URL: $PRODUCTION_FLYWAY_URL
      FLYWAY_USER: $PRODUCTION_FLYWAY_USER
      FLYWAY_PASSWORD: $PRODUCTION_FLYWAY_PASSWORD
    volumes:
      - ./sql:/flyway/sql

volumes:
  app_data:
  postgres_data:
